<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeIrDcAsEr</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
      <text y='.9em' font-size='90'>ðŸ˜ˆ</text>
    </svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500;700&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
    rel="stylesheet">

  <style>
    body {
      background-color: #212121;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }

    #run {
      font-size: 14vmin;
      font-family: jetbrains mono, monospace;
      font-weight: 700;
      color: #212121;
      height: 30vmin;
      width: 30vmin;
      border: 0px;
      border-radius: 100%;
      background-color: #303030;
      cursor: pointer;
      background-image: linear-gradient(to right, #911a80, #d42b45);
      /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); */
      opacity: 0.5;
      transition: opacity 0.2s, font-size 0.2s;

      position: fixed;
      left: 0;
      top: 0;
      will-change: transform;
      user-select: none;
    }

    #backdrop {
      position: fixed;
      inset: 0;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 0;
    }

    #run:hover {
      opacity: 1;
      font-size: 30px;
    }

    #run.is-hover {
      opacity: 0.75;
    }


    #controls {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      z-index: 2;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    #stop,
    #refresh,
    #gear {
      font-family: jetbrains mono, monospace;
      font-size: 14px;
      color: #bdbdbd;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    #gear {
      font-size: 24px;
      transform: translateY(-1px);
    }

    #refresh {
      font-size: 30px;
      transform: translateY(-1px);
    }

    #stop:hover,
    #refresh:hover,
    #gear:hover {
      color: white;
    }

    #settings {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-family: jetbrains mono, monospace;
      color: #bdbdbd;
      z-index: 2;

      width: min(520px, calc(100vw - 48px));
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    #settings .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin: 14px 0;
    }

    #settings label {
      font-size: 14px;
      user-select: none;
    }

    #settings input[type="range"] {
      width: 100%;
      accent-color: #bdbdbd;
      cursor: pointer;
    }

    #settingsExit {
      margin-top: 10px;
      font-family: jetbrains mono, monospace;
      font-size: 14px;
      color: #bdbdbd;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    #settingsExit:hover {
      color: white;
    }

    .settings-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
    }

    #settingsRandom {
      font-family: jetbrains mono, monospace;
      font-size: 14px;
      color: #bdbdbd;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    #settingsRandom:hover {
      color: white;
    }
  </style>
</head>

<body>
  <button id="run">Run</button>
  <div id="backdrop" aria-hidden="true"></div>

  <div id="controls">
    <button id="stop">stop</button>
    <button id="refresh" aria-label="reset" style="display:none">âŸ³</button>
    <button id="gear" aria-label="settings">âš™ï¸Ž</button>
  </div>

  <div id="settings" aria-hidden="true">
    <div class="row">
      <label for="accelRange">accel: <span id="accelVal"></span></label>
      <input id="accelRange" type="range" min="1" max="30" step="0.5" />
    </div>

    <div class="row">
      <label for="frictionRange">friction: <span id="frictionVal"></span></label>
      <input id="frictionRange" type="range" min="0" max="10" step="1" />
    </div>

    <div class="row">
      <label for="maxSpeedRange">maxSpeed: <span id="maxSpeedVal"></span></label>
      <input id="maxSpeedRange" type="range" min="1" max="70" step="1" />
    </div>

    <div class="row">
      <label for="bounceRange">bounce: <span id="bounceVal"></span></label>
      <input id="bounceRange" type="range" min="0" max="1" step="0.05" />
    </div>

    <div class="settings-actions">
      <button id="settingsRandom">random</button>
      <button id="settingsExit">exit</button>
    </div>
  </div>

  <script>
    const button = document.getElementById('run');
    const stopButton = document.getElementById('stop');
    const refreshButton = document.getElementById('refresh');

    const controls = document.getElementById('controls');
    const gearButton = document.getElementById('gear');
    const settingsPanel = document.getElementById('settings');
    const backdrop = document.getElementById('backdrop');
    const settingsExit = document.getElementById('settingsExit');
    const settingsRandom = document.getElementById('settingsRandom');

    const accelRange = document.getElementById('accelRange');
    const frictionRange = document.getElementById('frictionRange');
    const maxSpeedRange = document.getElementById('maxSpeedRange');
    const bounceRange = document.getElementById('bounceRange');

    const accelVal = document.getElementById('accelVal');
    const frictionVal = document.getElementById('frictionVal');
    const maxSpeedVal = document.getElementById('maxSpeedVal');
    const bounceVal = document.getElementById('bounceVal');

    let isStopped = false;
    let stopTimerStarted = false;
    let stopRevealTimer = null;
    let inSettings = false;

    const defaultCfg = {
      fleeRadius: 220,     // px: when cursor gets closer than this, button runs away
      accel: 6,            // acceleration multiplier
      friction: 1,         // 0..1: lower = more damping
      maxSpeed: 14,        // px per frame
      bounce: 0.7          // 0..1: energy kept on wall bounce
    };

    const cfg = { ...defaultCfg };

    let impactHoverTimer = null;

    function triggerImpactHover(ms = 180) {
      button.classList.add('is-hover');
      clearTimeout(impactHoverTimer);
      impactHoverTimer = setTimeout(() => {
        button.classList.remove('is-hover');
      }, ms);
    }

    // "Flee" physics

    let mouseX = window.innerWidth / 2;
    let mouseY = window.innerHeight / 2;

    // Button position in px (top-left corner)
    let posX = 0;
    let posY = 0;
    let velX = 0;
    let velY = 0;

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    function frictionFromUI(u) {
      // 0 = no friction, 10 = max friction
      const t = clamp(u / 10, 0, 1);
      return 1.0 - t * 0.06; // 1.00 .. 0.94
    }

    function frictionUIFromInternal(f) {
      const u = ((1.0 - f) / 0.06) * 10;
      return Math.round(clamp(u, 0, 10));
    }

    function resetToCenter() {
      const rect = button.getBoundingClientRect();
      posX = (window.innerWidth - rect.width) / 2;
      posY = (window.innerHeight - rect.height) / 2;
      velX = 0;
      velY = 0;
      button.style.transform = `translate3d(${posX}px, ${posY}px, 0)`;
    }

    resetToCenter();

    function showControls() {
      controls.style.opacity = '0.6';
      controls.style.pointerEvents = 'auto';
    }

    function hideControls() {
      controls.style.opacity = '0';
      controls.style.pointerEvents = 'none';
    }

    function showBackdrop() {
      backdrop.style.opacity = '1';
      backdrop.setAttribute('aria-hidden', 'false');
    }

    function hideBackdrop() {
      backdrop.style.opacity = '0';
      backdrop.setAttribute('aria-hidden', 'true');
    }

    function showStopGear() {
      stopButton.style.display = '';
      gearButton.style.display = '';
      refreshButton.style.display = 'none';
    }

    function showRefreshOnly() {
      stopButton.style.display = 'none';
      gearButton.style.display = 'none';
      refreshButton.style.display = '';
    }

    function showSettings() {
      inSettings = true;
      isStopped = true;
      velX = 0;
      velY = 0;

      hideControls();
      showBackdrop();
      showStopGear();
      settingsPanel.style.opacity = '1';
      settingsPanel.style.pointerEvents = 'auto';
      settingsPanel.setAttribute('aria-hidden', 'false');
    }

    function hideSettings() {
      hideBackdrop();
      inSettings = false;
      settingsPanel.style.opacity = '0';
      settingsPanel.style.pointerEvents = 'none';
      settingsPanel.setAttribute('aria-hidden', 'true');
    }

    function frictionFromUI(u) {
      // u: 0..10 (user-facing)
      // 0  -> no friction
      // 10 -> strong friction
      const t = clamp(u / 10, 0, 1);
      // Inverted mapping: higher u => more damping
      return 1.0 - t * 0.06; // 1.00 .. 0.94
    }

    function frictionUIFromInternal(f) {
      const u = ((1.0 - f) / 0.06) * 10;
      return Math.round(clamp(u, 0, 10));
    }

    function syncSettingsUI() {
      accelRange.value = String(cfg.accel);
      const frictionUI = frictionUIFromInternal(cfg.friction);
      frictionRange.value = String(frictionUI);
      maxSpeedRange.value = String(cfg.maxSpeed);
      bounceRange.value = String(cfg.bounce);

      accelVal.textContent = cfg.accel;
      frictionVal.textContent = frictionUI;
      maxSpeedVal.textContent = cfg.maxSpeed;
      bounceVal.textContent = Number(cfg.bounce).toFixed(2);
    }

    function resetToInitial() {
      // clear timers
      if (stopRevealTimer) {
        clearTimeout(stopRevealTimer);
        stopRevealTimer = null;
      }
      stopTimerStarted = false;

      // reset UI
      hideSettings();
      hideBackdrop();
      hideControls();
      showStopGear();

      // reset physics
      isStopped = false;
      Object.assign(cfg, defaultCfg);
      syncSettingsUI();
      resetToCenter();
      lastFrameTime = null;
    }

    syncSettingsUI();
    hideControls();
    hideSettings();
    hideBackdrop();
    showStopGear();

    document.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    });

    let lastFrameTime = null;

    function tick(now) {
      if (lastFrameTime === null) lastFrameTime = now;
      const dtMs = now - lastFrameTime;
      lastFrameTime = now;

      // Normalize to ~60fps steps (16.67ms). Clamp to avoid huge jumps on tab-switch.
      const dt = clamp(dtMs / 16.67, 0, 3);

      if (isStopped || inSettings) {
        button.style.transform = `translate3d(${posX}px, ${posY}px, 0)`;
        requestAnimationFrame(tick);
        return;
      }
      const rect = button.getBoundingClientRect();
      const centerX = posX + rect.width / 2;
      const centerY = posY + rect.height / 2;

      const dx = mouseX - centerX;
      const dy = mouseY - centerY;
      const dist = Math.hypot(dx, dy);

      if (dist > 0 && dist < cfg.fleeRadius) {
        if (!stopTimerStarted) {
          stopTimerStarted = true;
          stopRevealTimer = setTimeout(() => {
            showControls();
          }, 1000);
        }
        // Run away from the cursor, stronger when closer
        const t = 1 - dist / cfg.fleeRadius; // 0..1
        const nx = dx / dist;
        const ny = dy / dist;

        velX += (-nx) * cfg.accel * (t * t) * 18 * dt;
        velY += (-ny) * cfg.accel * (t * t) * 18 * dt;
      }

      // Clamp speed
      velX = clamp(velX, -cfg.maxSpeed, cfg.maxSpeed);
      velY = clamp(velY, -cfg.maxSpeed, cfg.maxSpeed);

      // Integrate
      posX += velX * dt;
      posY += velY * dt;

      // Walls (viewport bounce)
      const maxX = window.innerWidth - rect.width;
      const maxY = window.innerHeight - rect.height;

      let bounced = false;

      if (posX < 0) {
        posX = 0;
        velX = -velX * cfg.bounce;
        bounced = true;
      } else if (posX > maxX) {
        posX = maxX;
        velX = -velX * cfg.bounce;
        bounced = true;
      }

      if (posY < 0) {
        posY = 0;
        velY = -velY * cfg.bounce;
        bounced = true;
      } else if (posY > maxY) {
        posY = maxY;
        velY = -velY * cfg.bounce;
        bounced = true;
      }

      if (bounced) triggerImpactHover();

      // Friction (damping)
      const damping = Math.pow(cfg.friction, dt);
      velX *= damping;
      velY *= damping;

      button.style.transform = `translate3d(${posX}px, ${posY}px, 0)`;
      requestAnimationFrame(tick);
    }

    requestAnimationFrame(tick);

    window.addEventListener('resize', () => {
      // Keep the "initial" layout invariant on resize
      if (!stopTimerStarted && !inSettings) resetToCenter();
    });

    stopButton.addEventListener('click', () => {
      isStopped = true;
      inSettings = false;
      velX = 0;
      velY = 0;

      // Replace STOP with a RESET icon in the same place
      showRefreshOnly();
      showControls();
    });

    refreshButton.addEventListener('click', () => {
      resetToInitial();
    });

    gearButton.addEventListener('click', () => {
      showSettings();
    });

    function randomizeSettings() {
      cfg.accel = Number((Math.random() * (30 - 1) + 1).toFixed(1));
      cfg.friction = frictionFromUI(Math.floor(Math.random() * 11));
      cfg.maxSpeed = Math.floor(Math.random() * (70 - 1 + 1)) + 1;
      cfg.bounce = Number((Math.random()).toFixed(2));
      syncSettingsUI();
    }

    settingsRandom.addEventListener('click', () => {
      randomizeSettings();
    });

    settingsExit.addEventListener('click', () => {
      hideSettings();
      isStopped = false;
      showStopGear();
      showControls();
    });

    function bindRange(rangeEl, onValue) {
      rangeEl.addEventListener('input', () => {
        onValue(rangeEl.value);
        syncSettingsUI();
      });
    }

    bindRange(accelRange, (v) => { cfg.accel = Number(v); });
    bindRange(frictionRange, (v) => {
      cfg.friction = frictionFromUI(Number(v));
    });
    bindRange(maxSpeedRange, (v) => { cfg.maxSpeed = Number(v); });
    bindRange(bounceRange, (v) => { cfg.bounce = Number(v); });

    button.addEventListener('click', () => {
      if (inSettings) return;
      let str = prompt('enter text');
      if (str === null) return;

      let newStr = '';
      let letterIndex = 0;

      for (let i = 0; i < str.length; i++) {
        if (str[i] === ' ') {
          newStr += ' ';
        } else {
          newStr += letterIndex % 2 === 0
            ? str[i].toUpperCase()
            : str[i].toLowerCase();
          letterIndex++;
        }
      }

      alert(newStr);
    });
  </script>
</body>

</html>